name: Build JSP Web (Azure)

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout source code
        uses: actions/checkout@v2

      # 2. Azure 로그인 (Service Principal 사용)
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. Azure 구독 설정 (필수)
      - name: Set Azure subscription
        run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 4. ACR 로그인 (Docker Login Action 사용)
      - name: Login to Azure Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}   # ex: drplanacr.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}       # ACR 관리자 사용자명
          password: ${{ secrets.ACR_PASSWORD }}       # ACR 관리자 암호

      # 5. 이미지 태그 생성
      - name: Generate image tag
        id: image
        run: |
          VERSION=$(echo "${GITHUB_SHA}" | cut -c1-8)-$(date +%s)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 6. Docker 이미지 빌드 & ACR에 푸시
      - name: Build and Push image to Azure ACR
        env:
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          IMAGE_TAG: ${{ steps.image.outputs.version }}
        run: |
          docker build -t $ACR_LOGIN_SERVER/drplan-acr-repo:$IMAGE_TAG .
          docker push $ACR_LOGIN_SERVER/drplan-acr-repo:$IMAGE_TAG

      # 7. Kustomize 설치
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v1

      # 8. Azure manifest 레포지토리 체크아웃
      - name: Checkout kustomize repository (Azure)
        uses: actions/checkout@v2
        with:
          repository: newbie507/AZURE_Seoul_manifests
          ref: main
          token: ${{ secrets.ACTION_TOKEN }}
          path: manifests-azure

      # 9. kustomization.yaml 이미지 업데이트
      - name: Update Kubernetes resources (Azure)
        run: |
          cd AZURE_Seoul_manifests
          kustomize edit clear images
          kustomize edit set image ${{ secrets.ACR_LOGIN_SERVER }}/drplan-acr-repo:${{ steps.image.outputs.version }}
          cat kustomization.yaml

      # 10. 변경된 파일 커밋 & 푸시 (Azure)
      - name: Commit and Push changes
        run: |
          cd manifests-azure
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          if ! git diff --quiet; then
            git commit -am "Update image tag to ${{ steps.image.outputs.version }}"
            git push
          else
            echo "No changes to commit"
          fi
