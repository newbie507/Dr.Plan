name: Build JSP Web (Azure)

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # í ½í³¦ 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v2

      # í ½í´‘ 2. Azure ë¡œê·¸ì¸
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # í ½í´‘ 3. Azure ACR ë¡œê·¸ì¸
      - name: Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # í ¼í¿·ï¸ 4. ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
      - name: Generate image tag
        id: image
        run: |
          VERSION=$(echo "${GITHUB_SHA}" | cut -c1-8)-$(date +%s)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # í ½í°³ 5. JSP ì´ë¯¸ì§€ ë¹Œë“œ & Azure ACRì— í‘¸ì‹œ
      - name: Build, tag, and push image to Azure ACR
        env:
          IMAGE_TAG: ${{ steps.image.outputs.version }}
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
        run: |
          docker build -t $ACR_LOGIN_SERVER/drplan-acr-repo:$IMAGE_TAG .
          docker push $ACR_LOGIN_SERVER/drplan-acr-repo:$IMAGE_TAG

      # í ½í³ 6. Kustomize ì„¤ì¹˜
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v1

      # í ½í³‚ 7. Azure manifest ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout kustomize repository (Azure)
        uses: actions/checkout@v2
        with:
          repository: newbie507/Azure_manifests
          ref: main
          token: ${{ secrets.ACTION_TOKEN }}
          path: manifests-azure

      # í ½í³ 8. kustomization.yaml ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
      - name: Update Kubernetes resources (Azure)
        run: |
          echo "âœ… Updating kustomization.yaml"
          cd manifests-azure
          kustomize edit clear images
          kustomize edit set image ${{ secrets.ACR_LOGIN_SERVER }}/drplan-acr-repo=${{ secrets.ACR_LOGIN_SERVER }}/drplan-acr-repo:${{ steps.image.outputs.version }}
          cat kustomization.yaml

      # í ½í²¾ 9. ë³€ê²½ëœ íŒŒì¼ ì»¤ë°‹ & í‘¸ì‹œ (Azure)
      - name: Commit and push changes
        run: |
          cd manifests-azure
          git config --global user.email "github-actions@github.com"
          git config --global user.name "dltjgusdltjgus"
          if ! git diff --quiet; then
            git commit -am "update image tag to ${{ steps.image.outputs.version }}"
            git push
          else
            echo "No changes to commit"
          fi

